# S3 Файл Хуулах API Route

## Тойм
Энэхүү Next.js API route нь AWS S3 руу файл хуулахыг бүрэн баталгаажуулалт болон алдаа засварлалтаар боловсруулдаг.

## Endpoint
`POST /api/upload`

## Функцүүд
- ✅ Олон файл хуулах (10 хүртэл файл)
- ✅ Файлын төрөл баталгаажуулалт
- ✅ Файлын хэмжээ баталгаажуулалт (файл тус бүр дээд тал нь 10MB)
- ✅ Файлын нэр цэвэрлэх
- ✅ UUID ашиглан өвөрмөц файлын нэр үүсгэх
- ✅ CloudFront URL интеграци
- ✅ Мета өгөгдөл хадгалах (анхны нэр, хуулсан огноо)
- ✅ Орчны хувьсагч баталгаажуулалт
- ✅ Иж бүрэн алдаа засварлалт

## Шаардлагатай Орчны Хувьсагчид
```env
AWS_REGION=us-east-1
S3_ACCESS_KEY=таны_хандах_түлхүүр
S3_SECRET_ACCESS_KEY=таны_нууц_түлхүүр
BUCKET_NAME=таны_bucket_нэр
CLOUDFRONT_URL=https://таны-cloudfront-url.cloudfront.net
```

## Файлын Хязгаарлалт

### Файлын Дээд Хэмжээ
- **10MB** файл тус бүр

### Файлын Дээд Тоо
- **10 файл** нэг хүсэлтэд

### Зөвшөөрөгдсөн Файлын Төрлүүд
- `image/jpeg` - JPEG зураг
- `image/png` - PNG зураг
- `image/gif` - GIF зураг
- `image/webp` - WebP зураг
- `application/pdf` - PDF баримт
- `text/plain` - Энгийн текст файл
- `text/csv` - CSV файл

## Хүсэлтийн Формат

### Арга
`POST`

### Content-Type
`multipart/form-data`

### Body
FormData-г `files` түлхүүрт файлуудтай:
```javascript
const formData = new FormData();
formData.append('files', file1);
formData.append('files', file2);
// ... 10 хүртэл файл
```

## Хариултын Формат

### Амжилттай Хариулт (200)
```json
{
  "success": true,
  "files": [
    {
      "fileName": "анхны-нэр.jpg",
      "key": "uploads/цэвэрлэсэн_нэр_uuid.jpg",
      "url": "https://таны-cloudfront-url.cloudfront.net/uploads/цэвэрлэсэн_нэр_uuid.jpg",
      "size": 1234567,
      "type": "image/jpeg"
    }
  ]
}
```

### Алдааны Хариултууд

#### Файл Өгөөгүй (400)
```json
{
  "error": "Файл өгөөгүй байна"
}
```

#### Хэт Олон Файл (400)
```json
{
  "error": "Хэт олон файл. Дээд тал нь 10 файл зөвшөөрөгдөнө"
}
```

#### Файлын Хэмжээ Хэтэрсэн (400)
```json
{
  "error": "example.jpg файл дээд хэмжээ 10MB-ээс хэтэрсэн"
}
```

#### Буруу Файлын Төрөл (400)
```json
{
  "error": "application/zip файлын төрөл зөвшөөрөгдөөгүй"
}
```

#### Хуулалт Амжилтгүй (500)
```json
{
  "error": "Хуулалт амжилтгүй боллоо",
  "details": "Алдааны дэлгэрэнгүй (зөвхөн хөгжүүлэлтийн горимд)"
}
```

#### Арга Зөвшөөрөгдөөгүй (405)
```json
{
  "error": "Арга зөвшөөрөгдөөгүй"
}
```

## Кодын Бүтэц

### Үндсэн Функцүүд

#### `validateFile(file: File)`
Файл бүрийн хэмжээ болон төрлийн хязгаарлалтыг баталгаажуулна.
- **Параметрүүд**: Файлын объект
- **Буцаана**: Алдааны мессеж string эсвэл зөв бол null

#### `sanitizeFileName(fileName: string)`
Аюултай тэмдэгтүүдийг арилгаж файлын нэрийг цэвэрлэнэ.
- **Параметрүүд**: Анхны файлын нэр string
- **Буцаана**: Цэвэрлэсэн файлын нэр (жижиг үсэг, үсэг тоо болон доогуур зураастай)

#### `POST(request: NextRequest)`
Файл хуулах хүсэлтийн үндсэн боловсруулагч.
- **Алхамууд**:
  1. Хүсэлтээс FormData задлах
  2. Файлын тоог баталгаажуулах
  3. Файл бүрийг баталгаажуулах (хэмжээ ба төрөл)
  4. Файлуудыг buffer болгон хувиргах
  5. Өвөрмөц файлын нэр үүсгэх
  6. Мета өгөгдөлтэй S3 руу хуулах
  7. Файлын URL-тай амжилттай хариулт буцаах

### S3 Хуулах Процесс

1. **Buffer Хувиргалт**: Файл Buffer болгон хувирна
2. **Файлын Нэр Үүсгэх**: 
   - Файлын өргөтгөл задлах
   - Анхны файлын нэр цэвэрлэх
   - Өвөрмөц байдлын төлөө UUID нэмэх
   - Формат: `цэвэрлэсэн_нэр_uuid.ext`
3. **S3 Хуулалт**:
   - `uploads/` фолдерт хадгална
   - Content type орно
   - Мета өгөгдөл орно (анхны нэр, хуулсан огноо)
4. **URL Үүсгэх**: Файлд хандахын тулд CloudFront URL буцаана

## Аюулгүй Байдлын Функцүүд

1. **Орчны Хувьсагч Баталгаажуулалт**: Эхлүүлэхдээ шаардлагатай бүх env хувьсагчдыг шалгана
2. **Файлын Төрлийн Цагаан Жагсаалт**: Зөвхөн зөвшөөрөгдсөн MIME төрлүүдийг хуулж болно
3. **Файлын Хэмжээний Хязгаар**: Том файл хуулахаас сэргийлнэ
4. **Файлын Нэр Цэвэрлэх**: Аюултай тэмдэгтүүдийг арилгана
5. **Алдааны Мессеж Цэвэрлэх**: Үйлдвэрлэлийн горимд дотоод алдаануудыг ил болгохгүй
6. **Хүсэлт Баталгаажуулалт**: Хоосон эсвэл хэт олон файлын хуулалтыг шалгана

## Хэрэглээний Жишээ

### Frontend (React/Next.js)
```typescript
const uploadFiles = async (files: File[]) => {
  const formData = new FormData();
  
  files.forEach(file => {
    formData.append('files', file);
  });

  const response = await fetch('/api/upload', {
    method: 'POST',
    body: formData,
  });

  const result = await response.json();
  
  if (result.success) {
    console.log('Хуулсан файлууд:', result.files);
  } else {
    console.error('Хуулалтын алдаа:', result.error);
  }
};
```

## Дэмжигдсэн HTTP Аргууд

- `POST` - Файл хуулах ✅
- `GET` - Зөвшөөрөгдөөгүй (405 буцаана)
- `PUT` - Зөвшөөрөгдөөгүй (405 буцаана)
- `DELETE` - Зөвшөөрөгдөөгүй (405 буцаана)

## Файл Хадгалах Бүтэц

Файлууд S3 дээр дараах бүтцээр хадгалагдана:
```
bucket-name/
└── uploads/
    ├── цэвэрлэсэн_нэр_uuid1.jpg
    ├── өөр_файл_uuid2.pdf
    └── баримт_uuid3.csv
```

## CloudFront Интеграци

API нь CDN хүргэлтэд CloudFront ашигладаг:
- Дэлхий даяар илүү хурдан файл хандалт
- S3 өгөгдлийн дамжуулалтын зардал бууруулах
- Хэрэглэгчдэд илүү сайн гүйцэтгэл

**URL Формат**: `${CLOUDFRONT_URL}/uploads/${uniqueFileName}`

## Алдаа Засварлалт

Route нь иж бүрэн алдаа засварлалт агуулдаг:
- Эхлүүлэхдээ орчны хувьсагчдыг баталгаажуулна
- Боловсруулахаас өмнө хүсэлтийн өгөгдлийг баталгаажуулна
- Хуулалтын алдаануудыг барьж лог хөтөлнө
- Зохих HTTP статус кодыг буцаана
- Үйлдвэрлэлийн горимд алдааны мессежүүдийг цэвэрлэнэ

## Хөгжүүлэлт болон Үйлдвэрлэл

### Хөгжүүлэлтийн Горим
- Хариултад алдааны дэлгэрэнгүй орно
- Бүрэн алдааны мессежүүд консолд лог хөтлөгдөнө

### Үйлдвэрлэлийн Горим
- Зөвхөн ерөнхий алдааны мессежүүд
- Нууц мэдээлэл нуугдсан
- Алдааны дэлгэрэнгүй клиент руу илчлэгдэхгүй

## Туршилтын Зөвлөмжүүд

1. **Файлын хэмжээний хязгаар турших**: 10MB-аас их файл хуулж үзээрэй
2. **Файлын төрлийн хязгаарлалт турших**: .exe, .zip гэх мэт хуулж үзээрэй
3. **Олон файл турших**: Нэг дор 10 файл хуулж үзээрэй
4. **Хэт олон файл турших**: 11+ файл хуулж үзээрэй
5. **Хоосон хүсэлт турших**: Файлгүй хүсэлт илгээж үзээрэй
6. **Буруу аргууд турших**: GET, PUT, DELETE хүсэлт илгээж үзээрэй

## Хамаарлууд

```json
{
  "@aws-sdk/client-s3": "AWS S3 клиент сан",
  "uuid": "Өвөрмөч ID үүсгэх",
  "next": "Next.js фреймворк"
}
```

## Ирээдүйн Сайжруулалт

- [ ] Файл устгах endpoint нэмэх
- [ ] Файлын жагсаалт харуулах endpoint нэмэх
- [ ] Presigned URL дэмжлэг нэмэх
- [ ] Том файлын явцын хяналт
- [ ] Зураг хэмжээ өөрчлөх/оновчлох
- [ ] Вирус шалгах интеграци
- [ ] Хурдны хязгаарлалт
- [ ] Хэрэглэгчийн баталгаажуулалт/эрх олгох
